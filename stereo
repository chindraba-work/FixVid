#!/bin/bash

########################################################################
#                                                                      #
#  stereo: script to create external stereo sound files, in original   #
#  sound and with normalized, 'enhanced', sound.                       #
#                                                                      #
#  This file is part of FixVid, a system to semi-automatically modify  #
#  and re-encode video files to create an acceptable version for a     #
#  standardized collection or library of videos.                       #
#                                                                      #
#  Copyright Â© 2018, 2019  Ronald Lamoreaux <code@chindraba.work>      #
#  - All Rights Reserved                                               #
#                                                                      #
#  FixVid is free software; you can redistribute it and/or             #
#  modify it under the terms of the GNU General Public License,        #
#  version 2 only, as published by the Free Software Foundation.       #
#                                                                      #
#  FixVid is distributed in the hope that it will be useful,           #
#  but WITHOUT ANY WARRANTY; without even the implied warranty of      #
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the       #
#  GNU General Public License for more details.                        #
#                                                                      #
#  You should have received a copy of the GNU General Public License   #
#  along with this program; if not, write to the                       #
#        Free Software Foundation, Inc.                                #
#        51 Franklin Street                                            #
#        Fifth Floor                                                   #
#        Boston, MA  02110-1301                                        #
#        USA.                                                          #
#                                                                      #
########################################################################

#
# Command script to launch stereo sound extraction commands with all the
# proper parameters set. May launch the extraction multiple times if
# there are multiple occurrences of the configuration variables.
#

source "$fixvid_dir/extract-stereo";
source "$fixvid_dir/hts-downmix";

# The function to extract the stereo files
function get_stereo {
  # Set the output filename base
  stereo_prefix="${work_files}-sound-${audio_label}-stereo";
  stereo_norm_prefix="${stereo_prefix}-norm";

  # Skip this if it has already been done.
  # To rerun, delete the *-stereo-norm.* files first
  [[ 1 -ne $audio_make_aac ]] && \
  [[ 1 -ne $audio_include_aac ]] && \
    extension='ac3' || extension='aac';
  [[ -s "${stereo_norm_prefix}.$extension" ]] && return 0;


  [[ $audio_include_stereo ]] && \
  [[ $audio_mixing ]] && \
    process_hts_downmix || process_extract_stereo;
  return 0;
}

  # Read the optional target
  [[ $1 ]] && stereo_target=$1 || stereo_target=0;

  process_group get_stereo 'audio' $stereo_target;
  wait;
