#!/bin/bash

##
##      NOTE:
##
##  This file is only set up for processing of files related to a
##  surround sound soundtrack of either 5.1 or 5.1(side). Any other type
##  of surround sound setup, 7.1, etc., will require a complete set of
##  command files to replace hts-split, hts-normalize, and hts-merge
##

#
# Command script to take the 6 channels and build the 5.1 surround sound
# for the video.
#
# Accepts no arguments.
#
# Reads fixvid.conf for:
#     work_files    the prefix of filenames for work files
#     video_title   added to the title metadata of the files
#     channels      the filter used to join the channels into one stream
#     timestamp     entered in the creation_time metadata for streams
# Reads the 6 channel files made by hts-normalize:
#     *_surround_efc.wav       The adjusted front center channel
#     *_surround_efl.wav       The adjusted front left channel
#     *_surround_efr.wav       The adjusted front right channel
#     *_surround_elf.wav       The adjusted low frequency channel
#     *_surround_esl.wav       The adjusted surround left channel
#     *_surround_esl.wav       The adjusted surround right channel
#
# Displays the ffmpeg progress line while running amd the results of the
# time command once finished.
#
# Generates 2 file:
#     *_surround_adjusted.aac  The adjusted surround sound, AAC format
#     *_surround_adjusted.ac3  The adjusted surround sound, AC3 format
#

# Load the configuration file
test -s fixvid.conf && . fixvid.conf || exit 4;

# Set the output filename base
surround_prefix="${work_files}_surround";

# Skip this if it has already been done.
# To rerun, delete the *_split_fc.wav file first
if [ -s "${surround_prefix}_adjusted.ac3" ]; then
  exit;
fi

if \
  [ ! -s "${surround_prefix}_efc.wav" ] || \
  [ ! -s "${surround_prefix}_efl.wav" ] || \
  [ ! -s "${surround_prefix}_efr.wav" ] || \
  [ ! -s "${surround_prefix}_elf.wav" ] || \
  [ ! -s "${surround_prefix}_esl.wav" ] || \
  [ ! -s "${surround_prefix}_esr.wav" ]; then
    rm -f "${surround_prefix}_efc.wav"
    fixvid "hts-normalize";
fi

# Set the filename base for the command and log files
control_prefix="fixvid_${surround_prefix}_merge";

# Create the commmand file, which will do the work. It uses the data in
# the configuration file to "fill in the blanks" for the ffmpeg call
#

cat <<EOC > "$control_prefix.cmd"
FFREPORT=file='$control_prefix.log':level=40 \\
ffmpeg -hide_banner -y -loglevel error -stats \\
-fflags +igndts -i '${surround_prefix}_efc.wav' \\
-fflags +igndts -i '${surround_prefix}_efl.wav' \\
-fflags +igndts -i '${surround_prefix}_efr.wav' \\
-fflags +igndts -i '${surround_prefix}_elf.wav' \\
-fflags +igndts -i '${surround_prefix}_esl.wav' \\
-fflags +igndts -i '${surround_prefix}_esr.wav' \\
-filter_complex '\
  [1:0][2:0][0:0][3:0][4:0][5:0] amerge=inputs=6 [CHANNELS];\
  [CHANNELS] $channels [OUT];\
  [OUT] asplit [INTERNAL][EXTERNAL]\
' \\
-map "[EXTERNAL]" \\
-map_metadata -1 -metadata creation_time=$time_stamp \\
-metadata language=eng -metadata title="$video_title" \\
-metadata:s:0 language=eng -metadata:s:0 title="5.1 Surround (Enhanced)" \\
-c:0 ac3 -b:a 640k \\
-threads 64 -fflags +genpts \\
${surround_prefix}_adjusted.ac3 \\
-map "[INTERNAL]" \\
-map_metadata -1 -metadata creation_time=$time_stamp \\
-metadata language=eng -metadata:s:0 language=eng \\
-metadata title="$video_title" -metadata:s:0 title="5.1 Surround (Enhanced)" \\
-c:0 libfdk_aac -profile:a aac_he -b:a 384k \\
-threads 64 -fflags +genpts \\
${surround_prefix}_adjusted.aac;
EOC

# Make the newly created file executable
chmod +x "$control_prefix.cmd";

# Execute the just-made ffmpeg command
time ./"$control_prefix.cmd";
