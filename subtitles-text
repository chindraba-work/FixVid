#!/bin/bash


#
# Command script to extract the subtitles from a text-based file, such
# as an SRT or ASS file, or from an existing video file, and save them
# to a known named file for eventual inclusion in the finished product.
#
# Accepts four arguments:
#     source_file     the name of the file with the subtitles in it
#     source_stream   the stream index (zero-based) of the subtitles
#     subtitle_label  the label for the subtitles, used in the metadata
#     file_label      the <label> part of the generated file's name
#
# Reads fixvid.conf for:
#     work_files      the prefix of filenames for work files
#     video_title     added to the title metadata of the files
#     timestamp       entered in the creation_time metadata for streams
#
# Displays the ffmpeg progress line while running amd the results of the
# time command once finished.
#
# Generates 1 file:
#     *_<label>.ass   The copied subtitles in Substation Alpha format
#                     <label>
#

# Load the configuration file
test -s fixvid.conf && . fixvid.conf || exit 4;

# Read the arguments. All are required.
test -n "$1" && source_file="$1"    || exit 3;
test -n "$2" && source_stream="$2"  || exit 3;
test -n "$3" && subtitle_label="$3" || exit 3;
test -n "$4" && file_label="$4"     || exit 3;

# Set the output filename base
subs_prefix="${work_files}_subs_$file_label";

# Skip this if it has already been done.
# To rerun, delete the created .aac file first
if [ -s "${subs_prefix}.ass" ]; then
  exit;
fi

# Set the filename base for the command and log files
control_prefix="fixvid_${subs_prefix}";

FFREPORT=file='$control_prefix.log':level=40 \
ffmpeg -hide_banner -loglevel error -stats -y \
$input_flags -i "$source_file" \
-map 0:$source_stream \
$strip_meta_all \
-metadata creation_time="$timestamp" \
-metadata language=eng -metadata title="$video_title" \
-metadata:s:0 language=eng -metadata:s:0 title="$subtitle_label" \
-c:0 ass \
$subtitles_only $use_threads $output_flags \
"$subs_prefix.ass";


### LOG FILE
