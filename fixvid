#!/bin/bash

########################################################################
#                                                                      #
#  fixvid: the central launch point for the FixVid system              #
#                                                                      #
#  This file is part of FixVid, a system to semi-automatically modify  #
#  and re-encode video files to create an acceptable version for a     #
#  standardized collection or library of videos.                       #
#                                                                      #
#  Copyright Â© 2018, 2019  Chindraba (Ronald Lamoreaux)                #
#                          <fixvid@chindraba.work>                     #
#  - All Rights Reserved                                               #
#                                                                      #
#  FixVid is free software; you can redistribute it and/or             #
#  modify it under the terms of the GNU General Public License,        #
#  version 2 only, as published by the Free Software Foundation.       #
#                                                                      #
#  FixVid is distributed in the hope that it will be useful,           #
#  but WITHOUT ANY WARRANTY; without even the implied warranty of      #
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the       #
#  GNU General Public License for more details.                        #
#                                                                      #
#  You should have received a copy of the GNU General Public License   #
#  along with this program; if not, write to the                       #
#        Free Software Foundation, Inc.                                #
#        51 Franklin Street                                            #
#        Fifth Floor                                                   #
#        Boston, MA  02110-1301                                        #
#        USA.                                                          #
#                                                                      #
########################################################################

fixvid_version="0.2.0";

echo "";
echo "FixVid version $fixvid_version Copyright (c) 2018, 2019 Chindraba - All Rights Reserved";
echo "";
fixvid_source="${BASH_SOURCE[0]}"

while [ -L "$fixvid_source" ]; do
  fixvid_dir="$( cd -P "$( dirname "$fixvid_source" )" && pwd )"
  fixvid_source="$(readlink "$fixvid_source")"
  [[ $fixvid_source != /* ]] && fixvid_source="$fixvid_dir/$fixvid_source"
done
fixvid_dir="$( cd -P "$( dirname "$fixvid_source" )" && pwd )";
source "$fixvid_dir/functions";
video_lang="und"
[[ -s fixvid.conf ]] && source fixvid.conf;

function no_command {
  cat <<NOCMD | cat;

    No $(basename $0) command given.

    For available commands, use:
    $(basename $0) help

NOCMD
  exit;
}

function bad_command {
  cat <<BADCMD | cat;

    $1 is not a valid $(basename $0) command.

    For available commands, use:
    $(basename $0) help

BADCMD
  exit;
}

[[ $1 ]] || no_command;

command_check=$1;
command_target=$2;
force_run=${3:+1};
for prefix in audio titles video; do
  load_limit $prefix;
done
case "${command_check,,}" in
  a|audio )
    check $force_run && process_group audio_channels "$command_target";
    process_group audio_stereo "$command_target";
    check $force_run && process_group audio_normalize "$command_target";
    process_group audio_remix "$command_target";
    process_group audio_dts "$command_target";
    ;;
  d|dts )
    process_group audio_dts "$command_target";
    ;;
  p_probe )
    probe_file  "$command_target";
    ;;
  h|help )
    help $(basename $0) "$command_target";
    ;;
  i|init )
    init_dir;
    ;;
  all_sound )
    check $force_run && process_group audio_channels 0;
    process_group audio_stereo 0;
    check $force_run && sleep 1;
    check $force_run && process_group audio_normalize 0;
    process_group audio_remix 0;
    check $force_run && sleep 1;
    process_group audio_dts 0;
    ;;
  c|channels )
    process_group audio_channels "$command_target";
    ;;
  m|remix )
    process_group audio_remix "$command_target";
    ;;
  n|normalize )
    process_group audio_stereo "$command_target";
    process_group audio_normalize "$command_target";
    ;;
  g|go|one_shot )
    check $force_run && process_group audio_channels 0;
    process_group audio_stereo 0;
    check $force_run && sleep 1;
    check $force_run && process_group audio_normalize 0;
    process_group audio_remix 0;
    check $force_run && sleep 1;
    process_group audio_dts 0;
    sleep 1;
    process_group video_remux 0;
    ;;
  r|remux )
    process_group video_remux "$command_target";
    ;;
  s|stereo )
    process_group audio_stereo "$command_target";
    ;;
  t|titles )
    process_group titles_extract "$command_target";
    ;;
  v|video )
    process_group video_extract "$command_target";
    ;;
  ver|version )
    ;;
  * )
    bad_command $command_check
    ;;
esac
wait
echo "";
